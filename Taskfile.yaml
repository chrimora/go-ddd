version: '3'

dotenv: ['.env']

vars:
  DB_CONN: postgres://$POSTGRES_USER:$POSTGRES_PASSWORD@$POSTGRES_HOST:5432/$POSTGRES_DB?sslmode=disable

tasks:
  infra:
    desc: Start local infra
    cmds:
      - docker compose up -d

  server:
    desc: Run the server locally
    cmds:
      - go run cmd/server/main.go

  worker:
    desc: Run the worker locally
    cmds:
      - go run cmd/worker/main.go

  sqlgen:
    desc: Generate sqlc pkgs
    cmds:
      # sqlc does not suppoort yml anchors
      - yq eval 'explode(.) | del(.common_overrides)' sqlc.yaml > .sqlc.inline.yaml
      - sqlc generate -f .sqlc.inline.yaml

  migrate:
    desc: Applies DB schema from sql
    deps:
      - task: sqlgen
        silent: true
    cmds:
      - atlas schema apply --env default --url "{{.DB_CONN}}"

  test:
    desc: Run all tests
    cmds:
      - go test -p 1 ./... {{.CLI_ARGS}}
